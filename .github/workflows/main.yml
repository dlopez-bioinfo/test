name: Build and Push Docker Images

on:
  push:
    branches:
      - main  # Cambia a la rama deseada
    paths:
      - '**/Dockerfile'
      - 'main.yml'  

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Find changed Dockerfiles
        id: find_dockerfiles
        run: |
          # Encuentra Dockerfiles modificados en el último commit comparado al anterior
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | grep 'Dockerfile' || true)
          echo "Changed Dockerfiles: $CHANGED_FILES"
          
          # Crear archivo de entorno para almacenar la salida de dockerfiles
          if [ -n "$CHANGED_FILES" ]; then
            echo "dockerfiles=$CHANGED_FILES" >> $GITHUB_ENV
          else
            echo "dockerfiles=" >> $GITHUB_ENV
          fi

      - name: Build and push Docker images
        if: env.dockerfiles
        run: |
          # Leer Dockerfiles cambiados desde el archivo de entorno
          dockerfiles="${{ env.dockerfiles }}"
          for dockerfile in $dockerfiles
          do
            # Extraer el directorio donde está el Dockerfile
            dir=$(dirname "$dockerfile")
            # Usar el nombre del directorio como etiqueta (tag) en Docker Hub
            image_name="${{ secrets.DOCKER_USERNAME }}/$(basename $dir)"
            # Construir la imagen
            docker build -t "$image_name:latest" "$dir"
            # Subir la imagen
            docker push "$image_name:latest"
          done

